<?php
/**
 * @file: afrikaburn_registration.module
 */

use \Drupal\user\Entity\User;
use \Drupal\node\Entity\Node;


module_load_include('inc', 'afrikaburn_registration', 'includes/project.wizard');
// module_load_include('inc', 'afrikaburn_registration', 'includes/project.draft');


/* ----- Form alters ----- */


/**
 * Implements hook_form_alter().
 * Performs project form alterations.
 */
function afrikaburn_registration_form_alter(&$form, $form_state, $form_id) {

  module_load_include('inc', 'afrikaburn_registration', 'includes/form');
  $registration_config = _project_form_config();
  $defaults = @($registration_config)[$form_id];

  if (isset($defaults)){

    $user = User::load(\Drupal::currentUser()->id());
    $registration = \Drupal::routeMatch()->getParameter('node');
    $collective = _get_collective($registration);

    $is_wrangler = $user->hasRole($defaults['wrangler']);
    $is_admin = $user->hasRole('administrator');
    $is_complete = array_search($defaults['mode'], $form['field_prjr_complete']['widget']['#default_value']) !== FALSE;
    $is_new = !isset($registration);

    // Naughty naughty users
    if (!$collective) {
      drupal_set_message('Oops! You really should do that from within a collective', 'warning', true);
      $response = new Symfony\Component\HttpFoundation\RedirectResponse(\Drupal::url('<front>'));
      $response->send();
    }

    // The little things
    $form['#title'] = [
      '#type' => 'markup',
      '#markup' => _get_title($defaults, $collective, $registration),
    ];
    $form['actions']['submit']['#value'] = 'Submit';
    $form['#attached']['library'][] = 'afrikaburn_registration/registration';

    // Hide fields and inappropriate complete options per type
    $form['revision_log']['#access'] = $is_admin;
    $form['field_form_mode']['#type'] = 'hidden';
    $form['field_collective']['#access'] = $is_admin;
    if (!($is_wrangler || $is_admin)) $form['field_prjr_complete']['widget']['#type'] = 'hidden';
    $bundle = $form_state->getFormObject()->getEntity()->bundle();
    $form['field_prjr_complete']['widget']['#options'] = array_intersect_key(
      $form['field_prjr_complete']['widget']['#options'],
      _project_form_modes()[$bundle]['modes']
    );

    // Set defaults
    $form['field_collective']['widget'][0]['target_id']['#default_value'] = $collective;
    $form['field_form_mode']['widget'][0]['value']['#default_value'] = $defaults['mode'];
    if (!$is_wrangler) $form['field_prjr_complete']['widget']['#default_value'][] = $defaults['mode'];
    $form['#administrator'] = $is_admin || $is_wrangler;

    // Wizard or tabs (cake or death?)
    $form['#wizard'] = $is_new || $defaults['mode'] != 'edit' && ($incomplete || !$is_wrangler);

    // // Add "Save Draft" button.
    // $form['draft'] = [
    //   '#type' => 'submit',
    //   '#value' => 'Save Draft',
    //   '#limit_validation_errors' => [['title'], ['field_form_mode']],
    //   '#validate' => ['afrikaburn_registration_validate_draft'],
    //   '#submit' => ['afrikaburn_registration_save_draft'],
    // ];
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 * Attach settings form style.
 */
function afrikaburn_registration_form_afrikaburn_registration_settings_alter(&$form, $form_state, $form_id) {
  $form['#attached']['library'][] = 'afrikaburn_registration/settings';
}

/**
 * Implements hook_form_FORM_ID_alter().
 * Alters dashboard filter form.
 */
function afrikaburn_registration_form_views_exposed_form_alter(&$form, $form_state, $form_id) {

  $view = $form_state->getStorage('view')['view'];
  list($purpose, $type) = array_map('trim', explode(',', $view->storage->get('tag')));

  if ($purpose == 'wrangle') {
    $form['search']['#placeholder'] = 'project, person or collective';
    $form['status']['#options']['All'] = t('- any review state -');
    module_load_include('inc', 'afrikaburn_registration', 'includes/wrangle.projects');
    ar_prepare_wrangler_filter($form, $type);
  }
}


/* ---- View alters ----- */


/**
 * Implements hook_views_query_alter().
 * Change "unassigned" wrangler filter into IS NULL in query.
 */
function afrikaburn_registration_views_query_alter($view, $query){

  list($purpose, $type) = array_map('trim', explode(',', $view->storage->get('tag')));

  if ($purpose == 'wrangle' && $view->exposed_raw_input['wrangler'] == 'unassigned') {

    foreach ($query->where as &$condition_group) {
      foreach ($condition_group['conditions'] as &$condition) {
        if ($condition['field'] == 'node__field_prj_adm_wrangler.field_prj_adm_wrangler_target_id') {
          $condition = [
            'field' => 'field_prj_adm_wrangler_target_id',
            'operator' => 'IS NULL',
          ];
        }
      }
    }

  }
}

/* ----- Block alters ----- */


// function afrikaburn_registration_block_build_alter(&$build, $block){
//   if ($block->pluginId == ''){
//     dpm($build);
//   }
// }


/* ----- Theme hooks ----- */


/**
 * Implements hook_theme().
 * Views Customizaton.
 */
function afrikaburn_registration_theme(){
  return [

    // Collective projects
    'views_view_unformatted__collective_projects' => [
      'template' => 'views-view-unformatted--collective-projects',
      'base hook' => 'view',
      // 'file' => 'includes/collective.projects.inc',
    ],
    'views_view_fields__collective_projects' => [
      'template' => 'views-view-fields--collective-projects',
      'base hook' => 'view',
      // 'file' => 'includes/collective.projects.inc',
    ],

    // Wrangle art
    'views_view_unformatted__wrangle_art' => [
      'template' => 'views-view-unformatted--wrangle-projects',
      'base hook' => 'view',
      // 'file' => 'includes/collective.projects.inc',
    ],
    // 'views_view_fields__collective_projects' => [
    //   'template' => 'views-view-fields--collective-projects',
    //   'base hook' => 'view',
    //   'file' => 'includes/collective.projects.inc',
    // ],

  ];
}


/* ----- Preprocessing hooks ----- */


/**
 * Implements hook_preprocess_views_view().
 */
function afrikaburn_registration_preprocess_views_view(&$variables){
  switch ($variables['id']){

    case 'collective_projects':
      module_load_include('inc', 'afrikaburn_registration', 'includes/collective.projects');
      ar_prepare_collective_projects($variables);
    break;

    case 'wrangle_art':
      module_load_include('inc', 'afrikaburn_registration', 'includes/wrangle.projects');
      $variables['#attached']['library'][] = 'afrikaburn_registration/wrangle';
    break;

  }
}

/**
 * Implements hook_preprocess_views_view_fields().
 */
function afrikaburn_registration_preprocess_views_view_fields(&$variables) {
  switch ($variables['view']->id()){
    case 'collective_projects':
      module_load_include('inc', 'afrikaburn_registration', 'includes/collective.projects');
      ar_prepare_project_links($variables);
    break;
  }
}
